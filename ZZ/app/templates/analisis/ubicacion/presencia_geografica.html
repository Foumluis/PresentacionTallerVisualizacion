{% extends 'base.html' %}

{% block title %}Presencia Geográfica Pobre en EEUU{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-map me-2"></i>Presencia Geográfica Pobre en EEUU</h2>
            <p class="text-muted">Análisis de las zonas con baja presencia de ventas en Estados Unidos</p>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Mapa de Presencia Geográfica</h5>
                </div>
                <div class="card-body">
                    <div id="presenciaMap" style="height: 500px;"></div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-4">
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Estados con Menor Presencia</h5>
                </div>
                <div class="card-body">
                    <table class="table table-striped">
                        <thead>
                            <tr>
                                <th>#</th>
                                <th>Estado</th>
                                <th>Cantidad de Ventas</th>
                            </tr>
                        </thead>
                        <tbody>
                            {% for item in bottom_10_data %}
                            <tr>
                                <td>{{ forloop.counter }}</td>
                                <td>{{ item.estado }}</td>
                                <td>{{ item.cantidad }}</td>
                            </tr>
                            {% endfor %}
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
        <div class="col-md-6">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0">Recomendaciones</h5>
                </div>
                <div class="card-body">
                    <ul>
                        <li>Desarrollar estrategias de marketing para estados con baja presencia</li>
                        <li>Analizar barreras de entrada en mercados específicos</li>
                        <li>Considerar asociaciones locales para expandir la presencia</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block extra_js %}
<script>
    // Datos desde Django
    const todosEstados = {{ todos_estados|safe }};
    const todosCodigos = {{ todos_codigos|safe }};
    const todasCantidades = {{ todas_cantidades|safe }};

    // Debug - ver qué datos estamos recibiendo
    console.log('Estados:', todosEstados.length);
    console.log('Códigos:', todosCodigos.length);
    console.log('Cantidades:', todasCantidades.length);
    console.log('Primeros 5 estados:', todosEstados.slice(0, 5));
    console.log('Primeros 5 códigos:', todosCodigos.slice(0, 5));
    console.log('Primeros 5 cantidades:', todasCantidades.slice(0, 5));

    // Crear el mapa de calor con Plotly usando DATOS REALES
    const mapData = [{
        type: 'choropleth',
        locationmode: 'USA-states',
        locations: todosCodigos,
        z: todasCantidades,
        text: todosEstados.map((estado, i) => `${estado}<br>Ventas: ${todasCantidades[i]}`),
        hoverinfo: 'text',
        colorscale: [
            [0, 'rgb(255, 100, 100)'],      // Rojo oscuro (baja presencia)
            [0.2, 'rgb(255, 150, 100)'],    // Rojo-naranja
            [0.4, 'rgb(255, 200, 100)'],    // Naranja
            [0.6, 'rgb(255, 255, 150)'],    // Amarillo
            [0.8, 'rgb(150, 255, 150)'],    // Verde claro
            [1, 'rgb(50, 200, 50)']         // Verde oscuro (alta presencia)
        ],
        reversescale: false,
        colorbar: {
            title: {
                text: 'Cantidad de<br>Ventas',
                side: 'right'
            },
            thickness: 20,
            len: 0.7,
            tickformat: 'd'
        },
        marker: {
            line: {
                color: 'rgb(255, 255, 255)',
                width: 2
            }
        }
    }];

    const mapLayout = {
        title: {
            text: 'Presencia de Ventas por Estado en EE.UU.',
            font: {
                size: 20,
                color: '#1e3c72',
                family: 'Arial, sans-serif'
            }
        },
        geo: {
            scope: 'usa',
            projection: {
                type: 'albers usa'
            },
            showlakes: true,
            lakecolor: 'rgb(255, 255, 255)'
        },
        height: 500,
        margin: {
            l: 0,
            r: 0,
            t: 50,
            b: 0
        }
    };

    const config = {
        responsive: true,
        displayModeBar: true,
        displaylogo: false,
        modeBarButtonsToRemove: ['pan2d', 'lasso2d', 'select2d']
    };

    // Intentar crear el mapa con manejo de errores
    try {
        Plotly.newPlot('presenciaMap', mapData, mapLayout, config);
        console.log('Mapa creado exitosamente');
    } catch (error) {
        console.error('Error al crear el mapa:', error);
    }
</script>
{% endblock %}
