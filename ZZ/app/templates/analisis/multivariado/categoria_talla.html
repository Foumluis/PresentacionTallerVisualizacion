{% extends 'base.html' %}

{% block title %}Cantidad de Compras según Categoría y Talla de Artículo{% endblock %}

{% block content %}
<div class="container-fluid">
    <div class="row mb-4">
        <div class="col-12">
            <h2><i class="bi bi-box-seam me-2"></i>Cantidad de Compras según Categoría y Talla de Artículo</h2>
            <p class="text-muted">Análisis multivariado de las compras considerando categoría y talla</p>
        </div>
    </div>

    <div class="row">
        <div class="col-lg-8">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-bar-chart-fill me-2"></i>Cantidad de ventas por Categoría y Talla</h5>
                </div>
                <div class="card-body">
                    <div id="stackedBarChart" style="height: 539px;"></div>
                </div>
            </div>
        </div>
        
        <div class="col-lg-4">
            <div class="card">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-list-check me-2"></i>Análisis Detallado</h5>
                </div>
                <div class="card-body">
                    <h6 class="fw-bold mb-3">Distribución por Talla</h6>
                    <div id="sizeStats"></div>
                </div>
            </div>
            
            <div class="card mt-3">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-lightbulb me-2"></i>Conclusiones</h5>
                </div>
                <div class="card-body">
                    <ul class="list-unstyled">
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Las tallas M y L son las más vendidas en todas las categorías</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>La categoría Ropa tiene el mayor volumen de ventas</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Accesorios presenta demanda uniforme en todas las tallas</li>
                        <li class="mb-2"><i class="bi bi-check-circle-fill text-success me-2"></i>Las tallas extremas (S y XL) tienen menor demanda</li>
                    </ul>
                </div>
            </div>
        </div>
    </div>
</div>

{{ categories|json_script:"categories-data" }}
{{ sizes|json_script:"sizes-data" }}
{{ size_data|json_script:"size-data" }}
{% endblock %}

{% block extra_js %}
<script>
    // Parse data from Django
    const categories = JSON.parse(document.getElementById('categories-data').textContent);
    const sizes = JSON.parse(document.getElementById('sizes-data').textContent);
    const sizeData = JSON.parse(document.getElementById('size-data').textContent);

    // Define colors for each size (matching the image style)
    const sizeColors = {
        'S': '#D81B60',    // Pink
        'M': '#E6D690',    // Yellow/Beige
        'L': '#6FB3B8',    // Light Teal
        'XL': '#2E7D7B'    // Dark Teal
    };

    // Create traces for each size (stacked bars)
    const traces = sizes.map(size => ({
        name: size,
        x: categories,
        y: sizeData[size],
        type: 'bar',
        marker: {
            color: sizeColors[size] || '#95A5A6',
            line: {
                color: '#000000',
                width: 1.5
            }
        }
    }));

    // Layout configuration
    const layout = {
        title: {
            text: 'Cantidad de ventas por Categoría y Talla',
            font: { size: 16 }
        },
        barmode: 'stack',
        xaxis: {
            title: 'Categoría',
            tickfont: { size: 12 }
        },
        yaxis: {
            title: 'Cantidad de ventas',
            tickfont: { size: 12 }
        },
        legend: {
            title: { text: 'Tallas' },
            x: 1.02,
            y: 1
        },
        margin: {
            l: 60,
            r: 120,
            t: 60,
            b: 60
        },
        plot_bgcolor: '#f8f9fa',
        paper_bgcolor: '#ffffff'
    };

    // Create the chart
    Plotly.newPlot('stackedBarChart', traces, layout, {responsive: true});

    // Generate size statistics table
    function generateSizeStats() {
        let statsHtml = '<div class="table-responsive"><table class="table table-sm">';
        statsHtml += '<thead><tr><th>Talla</th><th>Total Ventas</th></tr></thead><tbody>';
        
        // Calculate total for each size across all categories
        const sizeTotals = {};
        sizes.forEach(size => {
            sizeTotals[size] = sizeData[size].reduce((a, b) => a + b, 0);
        });
        
        // Sort by total (descending)
        const sortedSizes = Object.entries(sizeTotals).sort((a, b) => b[1] - a[1]);
        
        sortedSizes.forEach(([size, total]) => {
            statsHtml += `<tr>
                <td><span class="badge" style="background-color: ${sizeColors[size] || '#95A5A6'}">${size}</span></td>
                <td><strong>${total.toLocaleString()}</strong></td>
            </tr>`;
        });
        
        statsHtml += '</tbody></table></div>';
        document.getElementById('sizeStats').innerHTML = statsHtml;
    }

    generateSizeStats();
</script>
{% endblock %}
